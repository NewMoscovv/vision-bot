Техническое задание
Проект: Telegram‑бот для поиска дефектов на фото детали с ИИ‑описанием

1. Цель проекта
Создать исследовательский прототип системы контроля качества, в которой пользователь отправляет боту два фото детали (вид сверху): эталон и проверяемое, а система:

- автоматически находит визуальные дефекты средствами классического компьютерного зрения;
- формирует человеко‑понятное текстовое описание найденных дефектов с помощью ИИ‑модели;
- возвращает пользователю текстовый вердикт и изображение с подсветкой дефектов.

2. Предметная область (домен)
Домен проекта — автоматизированная проверка качества детали по изображению. Основные доменные сущности:

- Деталь (представлена фотографией, сделанной сверху при фиксированных условиях).
- Дефект (локальная область на изображении, которая заметно отличается от «нормальной» поверхности: царапины, пятна, сколы и т.п.).
- Результат инспекции (наличие/отсутствие дефектов, их количество, примерное расположение и текстовое описание).

3. Сценарий работы системы

3.1. Основной сценарий

1) Пользователь открывает Telegram‑бота.
2) Пользователь отправляет боту эталонное фото детали (вид сверху).
3) Бот сохраняет эталон и ожидает второе фото.
4) Пользователь отправляет проверяемое фото детали (вид сверху).
5) Бот передаёт пару изображений в модуль компьютерного зрения.
6) Модуль компьютерного зрения сравнивает изображения, выделяет области отличий и формирует структурированный результат:
    - размеры исходного изображения;
    - список найденных дефектных областей (координаты, размеры, площадь);
    - флаг «есть дефекты / нет дефектов».
7) Если дефектов не найдено, бот отправляет пользователю текст:
    - «Дефекты не обнаружены.»
8) Если дефекты найдены:
    - поверх исходного изображения строится дополнительное изображение с подсветкой дефектных областей (рамки/контуры);
    - формируется «сырой отчёт» (структурированные данные о дефектах) и передаётся в ИИ‑модель;
    - ИИ‑модель возвращает краткое человеко‑понятное описание (сколько дефектов, где они расположены, какие крупнее);
    - бот отправляет пользователю:
        - текстовый вердикт (например: «Обнаружены дефекты» + текстовое описание от ИИ);
        - изображение с визуальной подсветкой дефектов.

3.2. Альтернативные сценарии

- Если пользователь отправляет не фото (текст, стикер и т.п.), бот отвечает сообщением вида:
«Пожалуйста, отправьте фото детали для проверки на дефекты.»
- Если при обработке изображения произошла ошибка (повреждённый файл, неподдерживаемый формат), бот отправляет пользователю сообщение об ошибке с просьбой повторить попытку.

4. Функциональные требования

4.1. Telegram‑бот

- Принимать от пользователя изображения (фото детали).
- Определять тип входящего сообщения (изображение/не изображение).
- При получении изображения:
    - сохранить эталонное фото (во временную директорию или в память);
    - запросить проверяемое фото;
    - после получения второго фото вызвать доменный сервис проверки детали;
    - по результату анализа отправить:
        - при отсутствии дефектов — только текстовый ответ;
        - при наличии дефектов — текст + обработанное изображение.
- Иметь минимум две команды:
    - /start — приветствие и краткая инструкция (например: «Отправьте фото детали сверху, я попробую найти и описать дефекты.»);
    - /help — более подробное описание работы и ограничений.

4.2. Модуль компьютерного зрения (детектор дефектов)

- Вход: байтовое представление пары изображений (эталон + проверяемое).
- Этапы обработки:

1) Загрузка двух изображений.
2) Приведение к одному размеру (если нужно).
3) Предобработка:
        - изменение размера (если нужно, чтобы привести к стандартным размерам);
        - преобразование в оттенки серого;
        - сглаживание/размытие для уменьшения шума.
4) Выделение кандидатов на дефекты:
        - вычисление карты отличий (например, через абсолютную разницу);
        - пороговая обработка (бинаризация) для выделения ярко выраженных участков;
        - поиск контуров или связных областей.
5) Фильтрация:
        - отбрасывание слишком маленьких областей по площади, чтобы уменьшить влияние шума.
6) Формирование результата:
        - ширина и высота изображения;
        - список дефектных областей, каждая с координатами (X, Y), шириной, высотой и площадью;
        - логический флаг HasDefects (true, если список дефектов не пуст).
- На основании списка дефектных областей модуль должен уметь построить изображение с подсветкой:
    - нарисовать вокруг каждой области прямоугольник, контур или маску.

4.3. Модуль ИИ‑описания (описатель дефектов)

- Вход: структурированный результат компьютерного зрения:
    - размеры изображения;
    - список дефектных областей (координаты, размеры, площадь).
- Дополнительно: фиксированный текстовый промпт с ролью (например: «Ты инженер по контролю качества деталей. Тебе передают размеры изображения и список дефектных областей…»).
- Задача модуля:
    - определить, сколько дефектов найдено;
    - описать их примерное расположение на детали (верхняя/нижняя часть, левее/правее центра и т.п., исходя из координат относительно размеров изображения);
    - выделить, какие дефекты крупнее/значимее (по площади);
    - сформировать краткий текстовый отчёт (2–4 предложения) на русском языке.
- Выход: строка с текстовым описанием, которую бот может вставить в ответ пользователю.

5. Архитектура и разделение на слои

5.1. Доменный слой

- Определяет основные типы:
    - DefectArea (координаты, ширина, высота, площадь);
    - InspectionResult (размер изображения, массив дефектов, флаг HasDefects);
    - AiDescription (строка с текстовым описанием).
- Определяет интерфейсы:
    - DefectDetector:
        - метод вида Inspect(image []byte) (InspectionResult, error);
    - DefectDescriber:
        - метод вида Describe(result InspectionResult) (AiDescription, error).
- Доменный слой не знает о Telegram, форматах API и т.п., он только про «проверку детали» и «описание дефектов».

5.2. Инфраструктурный слой

- Реализация DefectDetector с использованием GoCV/OpenCV:
    - загрузка изображения;
    - вся низкоуровневая обработка и поиск дефектов.
- Реализация DefectDescriber:
    - клиент к ИИ‑модели (локальной или облачной);
    - подготовка текста/JSON для запроса;
    - получение и возврат текстового ответа.
- Логика работы Telegram‑бота:
    - получение апдейтов;
    - скачивание изображений;
    - вызов доменных интерфейсов;
    - формирование и отправка ответов.

6. Нефункциональные требования

- Язык реализации: Go (Golang).
- Библиотека для компьютерного зрения: GoCV (обёртка над OpenCV).
- Платформа взаимодействия с пользователем: Telegram.
- Время ответа:
    - желательно до 5–10 секунд на один запрос при стандартном размере изображения.
- Требования к входным данным:
    - одно изображение детали в распространённом формате (JPEG/PNG);
    - разумный размер файла (не слишком большой, чтобы не тормозить обработку).
- Проект носит демонстрационный и учебный характер:
    - точность определения дефектов не гарантируется;
    - возможны ложные срабатывания и пропуски дефектов;
    - рекомендуется снимать детали в максимально одинаковых условиях (одинаковый фон, освещение, расстояние).

7. Обработка ошибок и сообщения пользователю

- Если пришло не изображение — отправить подсказку:
«Пожалуйста, отправьте фото детали для проверки на дефекты.»
- Если изображение не удалось обработать (повреждённый файл, неподдерживаемый формат и т.п.) — отправить:
«Не удалось обработать изображение. Попробуйте сделать другое фото или отправить ещё раз.»
- Если ИИ‑модуль не ответил или произошла ошибка на его стороне — отправить:
    - «Дефекты найдены, но не удалось получить подробное описание. Повторите попытку позже.» или другой понятный текст.

8. Материалы для защиты/презентации

- Скриншоты работы бота:
    - пример без дефектов;
    - пример с дефектами (видно подсветку на картинке и текстовое описание).
- Краткое текстовое описание архитектуры:
    - Telegram → бот → модуль компьютерного зрения → модуль ИИ → ответ пользователю.
- Краткое объяснение, чем отличается классическое компьютерное зрение (GoCV/OpenCV) от ИИ‑описания (нейросеть).
- Таблица с несколькими тестовыми примерами:
    - входное фото;
    - реальные дефекты;
    - что сказал бот (вердикт и описание).
