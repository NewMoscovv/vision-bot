# Этапы разработки Vision Bot

## Обзор

Разработка разбита на 5 этапов. Каждый этап заканчивается работающим функционалом, который можно протестировать.

---

## Этап 1: Доменный слой

**Цель:** Создать ядро приложения — типы данных и интерфейсы.

### Задачи

- [x] Создать структуру папок `internal/domain/entity/` и `internal/domain/port/`
- [x] Реализовать `entity/defect.go` — структура `DefectArea`
- [x] Реализовать `entity/inspection.go` — структуры `InspectionResult`, `AiDescription`
- [x] Реализовать `entity/user.go` — структуры `User`, `UserState`
- [x] Реализовать `port/detector.go` — интерфейс `DefectDetector`
- [x] Реализовать `port/describer.go` — интерфейс `DefectDescriber`
- [x] Реализовать `port/user_repository.go` — интерфейс `UserRepository`

### Результат

Готовые доменные типы и интерфейсы, от которых зависят все остальные слои.

---

## Этап 2: Инфраструктура — хранилище пользователей

**Цель:** Реализовать in-memory хранилище для управления состоянием пользователей.

### Задачи

- [x] Создать папку `internal/infrastructure/storage/`
- [x] Реализовать `memory_user_repository.go` — in-memory реализация `UserRepository`

### Результат

Работающее хранилище пользователей с потокобезопасным доступом.

---

## Этап 3: Telegram-бот с состояниями

**Цель:** Доработать бота для обработки фото и управления состояниями пользователей.

### Задачи

- [x] Рефакторинг `internal/api/bot.go` — внедрить `UserRepository`
- [x] Добавить обработку входящих фотографий
- [x] Реализовать скачивание изображений из Telegram
- [x] Реализовать переходы между состояниями пользователя
- [x] Улучшить команды `/start` и `/help`
- [x] Добавить команду `/check` для начала проверки
- [x] Добавить команду `/cancel` для отмены
- [x] Добавить обработку текстовых сообщений (подсказка отправить фото)

### Результат

Бот принимает фото, управляет состояниями, но пока без реальной обработки изображений.

---

## Этап 4: Модуль компьютерного зрения (GoCV)

**Цель:** Реализовать детектор дефектов на основе OpenCV.

### Задачи

- [ ] Добавить зависимость `gocv.io/x/gocv` в `go.mod`
- [ ] Создать папку `internal/infrastructure/vision/`
- [ ] Реализовать `detector.go` — `GoCVDetector` (реализация `DefectDetector`)
  - [ ] Загрузка изображения
  - [ ] Преобразование в grayscale
  - [ ] Размытие (GaussianBlur)
  - [ ] Детекция краёв (Canny)
  - [ ] Поиск контуров
  - [ ] Фильтрация по площади
- [ ] Реализовать `highlighter.go` — подсветка дефектов на изображении
- [ ] Обновить Dockerfile для сборки с OpenCV
- [ ] Написать тесты с тестовыми изображениями

### Результат

Бот находит дефекты на изображениях и возвращает фото с подсветкой.

---

## Этап 5: Модуль ИИ-описания (Ollama/Qwen)

**Цель:** Добавить генерацию текстовых описаний дефектов через ИИ.

### Задачи

- [ ] Создать папку `internal/infrastructure/ai/`
- [ ] Реализовать `ollama.go` — `OllamaDescriber` (реализация `DefectDescriber`)
- [ ] Реализовать `prompt.go` — системный промпт для генерации описаний
- [ ] Добавить Ollama в `docker-compose.yml`
- [ ] Обновить конфигурацию (`OLLAMA_URL`, `OLLAMA_MODEL`)
- [ ] Реализовать fallback при недоступности ИИ
- [ ] Протестировать с разными моделями (qwen2.5:7b, qwen2.5:14b)

### Результат

Полностью работающий бот: детекция дефектов + текстовое описание от ИИ.

---

## Этап 6 (опционально): Application Service

**Цель:** Вынести бизнес-логику в отдельный сервис для лучшей архитектуры.

### Задачи

- [ ] Создать папку `internal/application/inspection/`
- [ ] Реализовать `service.go` — `InspectionService`
- [ ] Перенести логику оркестрации из бота в сервис
- [ ] Обновить бота для использования сервиса

### Результат

Чистая архитектура с разделением ответственности.

---

## Текущий прогресс

| Этап | Статус | Примечания |
|------|--------|------------|
| 1. Доменный слой | ✅ Готово | — |
| 2. Хранилище пользователей | ✅ Готово | — |
| 3. Telegram-бот | ✅ Готово | Заглушка для обработки фото |
| 4. Компьютерное зрение | ⏳ Не начат | — |
| 5. ИИ-описание | ⏳ Не начат | — |
| 6. Application Service | ⏳ Опционально | — |

---

## Порядок выполнения

```
Этап 1 ──▶ Этап 2 ──▶ Этап 3 ──▶ Этап 4 ──▶ Этап 5
   │                                           │
   └─────────────── Этап 6 (опционально) ◀─────┘
```

Каждый последующий этап зависит от предыдущего. Этап 6 можно выполнить в любой момент после этапа 3.
